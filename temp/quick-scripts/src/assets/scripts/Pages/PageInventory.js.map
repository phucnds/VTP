{"version":3,"sources":["assets/scripts/Pages/PageInventory.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\n//  - https://docs.cocos.com/creator/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - https://docs.cocos.com/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - https://docs.cocos.com/creator/manual/en/scripting/life-cycle-callbacks.html\n\nimport * as moment from 'moment'\nimport FrameMgr from '../common/FrameMgr';\nimport SoundMgr from '../common/SoundMgr';\nimport CompInventoryItem from '../components/CompInventoryItem';\nimport APIDefine from '../src/app/APIDefine';\nimport connect from \"../src/app/connect\";\nimport store, { RootState, AppDispatch } from \"../src/app/store\";\nimport wsgw from '../src/app/wsgw';\nimport GameDefine from '../src/common/GameDefine';\nimport { EAppPages, IPageWithEffect, pushPage, popPage, EAppPopups, pushPopup, PAGE_SHOW_EFFECT } from \"../src/features/SliceApp\";\nimport { resetInventory, resetTickets, syncInventory, syncTickets } from '../src/features/SliceInventory';\nimport Page from \"./Page\";\n\nconst { ccclass, property } = cc._decorator;\n\nexport enum InventoryTabs {\n    GIFT = 'GIFT',\n    TURN = 'TURN',\n}\nexport class PageInventory extends Page {\n    actions: any\n    props: any\n\n    @property(cc.Node)\n    public giftContainer: cc.Node = null;\n    @property(cc.Node)\n    public turnContainer: cc.Node = null;\n    @property(cc.ScrollView)\n    public giftScrollView: cc.ScrollView = null;\n    @property(cc.ScrollView)\n    public ticketScrollView: cc.ScrollView = null;\n    @property(cc.Node)\n    public giftContent: cc.Node = null;\n    @property(cc.Node)\n    public turnContent: cc.Node = null;\n    @property(cc.Prefab)\n    public inventoryItem: cc.Prefab = null;\n\n    @property(cc.Node)\n    public btnVoucher: cc.Node = null;\n    @property(cc.Node)\n    public btnGift: cc.Node = null;\n    @property(cc.Node)\n    public btnTurn: cc.Node = null;\n\n    private giftOffset = 0;\n    private ticketOffset = 0;\n    private needToFetchGift = true;\n    private needToFetchTicket = true;\n    private limit = 10\n    private tab = InventoryTabs.GIFT;\n    private tabToContainerMap = {\n        [InventoryTabs.GIFT]: 'giftContainer',\n        [InventoryTabs.TURN]: 'turnContainer',\n    }\n    private tabToContentMap = {\n        [InventoryTabs.GIFT]: 'giftContent',\n        [InventoryTabs.TURN]: 'turnContent',\n    }\n\n    onLoad() {\n        this.btnGift.on(cc.Node.EventType.TOUCH_END, () => {\n            this.onTabClick(this.btnGift, InventoryTabs.GIFT);\n        });\n        this.btnTurn.on(cc.Node.EventType.TOUCH_END, () => {\n            this.onTabClick(this.btnTurn, InventoryTabs.TURN);\n        });\n        this.btnVoucher.on(cc.Node.EventType.TOUCH_END, () => {\n            SoundMgr.playSfx(SoundMgr.Instance.SFX_BUTTON);\n            this.actions.pushPopup(EAppPopups.PopupGoToVoucher);\n        });\n        this.giftScrollView.node.on('bounce-bottom', () => this.fetchGiftHistory());\n        this.ticketScrollView.node.on('bounce-bottom', () => this.fetchTicketHistory());\n    }\n\n    protected onDisable(): void {\n        store.dispatch(resetInventory({}));\n        store.dispatch(resetTickets({}));\n        this[this.tabToContentMap[InventoryTabs.GIFT]].removeAllChildren();\n        this[this.tabToContentMap[InventoryTabs.TURN]].removeAllChildren();\n    }\n\n    init() {\n        this.giftOffset = 0;\n        this.ticketOffset = 0;\n        this.needToFetchGift = true;\n        this.needToFetchTicket = true;\n        this.onTabClick(this.btnGift, InventoryTabs.GIFT);\n    }\n\n    fetchGiftHistory() {\n        if (!this.needToFetchGift) return;\n        wsgw.userRequest(APIDefine.getAllRewardsHistory, { offset: this.giftOffset, limit: this.limit }, (e) => {\n            store.dispatch(syncInventory(e))\n            if (e.items.length < this.limit) this.needToFetchGift = false;\n            this.giftOffset += this.limit;\n            this.updateItems(InventoryTabs.GIFT);\n        }, console.error);\n    }\n\n    fetchTicketHistory() {\n        if (!this.needToFetchTicket) return;\n        wsgw.userRequest(APIDefine.getTicketsHistory, { offset: this.ticketOffset, limit: this.limit }, (e) => {\n            store.dispatch(syncTickets(e))\n            if (e.items.length < this.limit) this.needToFetchTicket = false;\n            this.ticketOffset += this.limit;\n\n            this.updateItems(InventoryTabs.TURN);\n        }, console.error);\n    }\n\n    onTabClick(button: cc.Node, tab: InventoryTabs) {\n        this.tab = tab;\n        SoundMgr.playSfx(SoundMgr.Instance.SFX_BUTTON);\n        this.disableAllTabs();\n        button.getChildByName('Background').getComponent(cc.Sprite).spriteFrame = FrameMgr.Instance['BUTTON_GOLD_SELECTED'];\n        button.getChildByName('Background').getChildByName('Label').color = GameDefine.COLOR_RED;\n        this[this.tabToContainerMap[tab]].active = true;\n\n        if (tab === InventoryTabs.GIFT) {\n            this.fetchGiftHistory();\n        } else if (tab === InventoryTabs.TURN) {\n            this.fetchTicketHistory();\n        }\n    }\n\n    disableAllTabs() {\n        this.giftContainer.active = false;\n        this.turnContainer.active = false;\n        this.btnGift.getChildByName('Background').getComponent(cc.Sprite).spriteFrame = FrameMgr.Instance['BUTTON_GOLD'];\n        this.btnTurn.getChildByName('Background').getComponent(cc.Sprite).spriteFrame = FrameMgr.Instance['BUTTON_GOLD'];\n        this.btnGift.getChildByName('Background').getChildByName('Label').color = GameDefine.COLOR_BROWN;\n        this.btnTurn.getChildByName('Background').getChildByName('Label').color = GameDefine.COLOR_BROWN;\n    }\n\n    updateItems(tab) {\n        let dataToUse = tab === InventoryTabs.GIFT ? this.props.inventory.rewards : this.props.inventory.tickets;\n\n        if (tab === InventoryTabs.GIFT) {\n            dataToUse.forEach((item, index) => {\n                const { claimedAt, prizeName, prizeType, amount } = item;\n\n                this.addItem(prizeType, this[this.tabToContentMap[tab]].childrenCount + 1, amount, moment(claimedAt).valueOf(), tab);\n            })\n        } else {\n            dataToUse.forEach((item, index) => {\n                const { date, amount } = item;\n\n                this.addItem('TURN', this[this.tabToContentMap[tab]].childrenCount + 1, amount, moment(date).valueOf(), tab);\n            })\n        }\n    }\n\n    addItem(type: string, index: number, value: number, timestampz: number, tab: InventoryTabs) {\n        const newItem = cc.instantiate(this.inventoryItem);\n        this[this.tabToContentMap[tab]].addChild(newItem);\n\n        newItem.getComponent(CompInventoryItem).init(type, index, value, timestampz);\n    }\n}\nconst mapStateToProps = (state: RootState) => ({\n    inventory: state.inventory,\n})\nconst mapDispatchToAction = (dispatch: AppDispatch) => ({\n    pushPage: (payload: EAppPages | IPageWithEffect) =>\n        dispatch(pushPage(payload)),\n    popPage: () => dispatch(popPage()),\n    pushPopup: (payload: EAppPopups) => dispatch(pushPopup(payload)),\n})\nexport default connect(mapStateToProps, mapDispatchToAction)(PageInventory)\n"]}