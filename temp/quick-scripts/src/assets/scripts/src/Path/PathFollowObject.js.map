{"version":3,"sources":["assets/scripts/src/Path/PathFollowObject.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\n//  - https://docs.cocos.com/creator/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - https://docs.cocos.com/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - https://docs.cocos.com/creator/manual/en/scripting/life-cycle-callbacks.html\n\nimport GameDefine from \"../common/GameDefine\";\nimport GameMgr, { GameStates } from \"../game/GameMgr\";\nimport Path from \"./Path\";\nimport Point from \"./Point\";\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class PathFollowObject extends cc.Component {\n    @property(Path)\n    protected path: Path = null;\n    @property(cc.Boolean)\n    protected loop: Boolean = true;\n    @property(Number)\n    protected delay: number = 0;\n    set Delay(delay: number) {\n        this.delay = delay;\n    }\n\n    @property(cc.Node)\n    protected currentPoint: cc.Node = null;\n    protected nextPoint: cc.Node = null;\n    protected distance: number = 0;\n    protected time: number = 0;\n    protected timer: number = 0;\n    protected initiated: boolean = false;\n    protected running: boolean = true;\n    protected speed: number = GameDefine.GIFT_SPEED;\n    protected pos: cc.Vec2;\n\n    get Initiated() {\n        return this.initiate;\n    }\n\n    pause() {\n        this.running = false;\n    }\n\n    resume() {\n        this.running = true;\n    }\n\n    GetBezierPosition(t: number) {\n        const p0 = this.currentPoint.getPosition();\n        const p0Forward = this.currentPoint.getComponent(Point).getForwardVector().mul(this.path.reverse ? -1 : 1);\n        const p1 = p0.add(p0Forward);\n        const p3 = this.nextPoint.getPosition();\n        const p3Back = this.currentPoint.getComponent(Point).getBackVector().mul(this.path.reverse ? -1 : 1);\n        const p2 = p3.sub(p3Back);\n\n        const a = p0.mul(Math.pow(1 - t, 3));\n        const b = p1.mul(3 * Math.pow(1 - t, 2) * t);\n        const c = p2.mul(3 * (1 - t) * Math.pow(t, 2));\n        const d = p3.mul(Math.pow(t, 3));\n        return a.add(b).add(c).add(d);\n    }\n\n    initiate() {\n        this.initiated = true;\n        if (!this.currentPoint) {\n            this.currentPoint = this.path.getStartPoint();\n            this.pos = this.currentPoint.getPosition();\n        } else {\n            this.pos = this.node.getPosition();\n        }\n\n        this.nextPoint = this.path.getNextPoint(this.currentPoint);\n        this.distance = this.nextPoint.position.sub(this.currentPoint.position).mag();\n        const passedDistance = this.pos.sub(this.currentPoint.getPosition()).mag();\n        this.time = passedDistance / this.speed;\n    }\n\n    initNextPoint() {\n        this.currentPoint = this.nextPoint;\n        this.nextPoint = this.path.getNextPoint(this.nextPoint);\n        this.distance = this.nextPoint.position.sub(this.currentPoint.position).mag();\n    }\n\n    update(dt) {\n        if (!this.running) return;\n\n        if (!this.initiated) {\n            this.timer += dt;\n            if (this.timer < this.delay) {\n                return\n            } else {\n                this.initiate();\n            };\n        }\n\n        this.time += dt;\n        if (this.time > this.distance / this.speed) {\n            this.time = 0;\n            this.initNextPoint()\n            if (this.nextPoint === this.path.getStartPoint()) {\n                this.completeLapCallback();\n                if (this.loop) {\n                } else {\n                    this.initiate()\n                }\n            }\n        }\n\n        const direction = this.GetBezierPosition(this.time / (this.distance / this.speed)).sub(this.pos).normalize();\n        this.pos = this.pos.add(direction.mul(this.speed).mul(dt));\n        this.node.setPosition(this.pos);\n    }\n\n    completeLapCallback() {\n    }\n}\n"]}